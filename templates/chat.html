<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Assistant Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="chat-header">
            <div class="header-content">
                <div class="logo">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                </div>
                <div class="header-text">
                    <h1>Medical Assistant</h1>
                    <p class="status">
                        <span class="status-dot"></span>
                        Online
                    </p>
                </div>
            </div>
        </header>

        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <div class="welcome-icon">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <h2>Welcome to Medical Assistant</h2>
                <p>I'm here to help answer your medical questions. Please note that I provide general information and should not replace professional medical advice.</p>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <button class="attach-btn" aria-label="Attach file">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>
                </button>
                <input 
                    type="text" 
                    id="userInput" 
                    placeholder="Type your medical question here..." 
                    aria-label="Message input"
                >
                <button class="send-btn" id="sendBtn" aria-label="Send message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            <p class="disclaimer">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Always consult with a healthcare professional for medical advice
            </p>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        // This array will store the conversation history
        let chatHistory = [];

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            const welcomeMsg = document.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            // Add user's message to the UI and history
            addMessage(message, 'user');
            chatHistory.push(message);
            userInput.value = '';

            // Show a temporary "thinking" message from the bot
            addMessage('Thinking...', 'bot');

            // --- Updated Fetch Request to send history ---
            const formData = new FormData();
            formData.append('msg', message);
            
            // Add the entire chat history to the form data
            chatHistory.forEach((entry) => {
                formData.append('history[]', entry);
            });

            fetch('/get', {
                method: 'POST',
                body: formData, // Send form data which can handle arrays
            })
            .then(response => response.text())
            .then(data => {
                const thinkingMessage = chatContainer.lastChild;
                if (thinkingMessage && thinkingMessage.querySelector('.message-bubble').innerText.startsWith('Thinking...')) {
                    thinkingMessage.remove();
                }

                // Add the real bot response to the UI and history
                addMessage(data, 'bot');
                chatHistory.push(data); // Add bot's response to history
            })
            .catch((error) => {
                console.error('Error:', error);
                const thinkingMessage = chatContainer.lastChild;
                if (thinkingMessage && thinkingMessage.querySelector('.message-bubble').innerText.startsWith('Thinking...')) {
                    thinkingMessage.remove();
                }
                addMessage('Sorry, something went wrong. Please try again.', 'bot');
            });
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            
            if (sender === 'bot') {
                avatar.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>`;
            } else {
                avatar.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>`;
            }

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerText = text; // Use innerText to correctly display newlines and prevent HTML injection

            const time = document.createElement('span');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            bubble.appendChild(time);

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

    </script>
</body>
</html>